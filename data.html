<!doctype html>
<html>

<head>
  <title>Smell MyCity</title>
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">
  <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/frame.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/controls.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/widgets.css" media="screen" rel="stylesheet" type="text/css" />
  <link href="css/custom.css" media="screen" rel="stylesheet" type="text/css" />
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <script src="js/menu.js"></script>
  <script src="js/widgets.js"></script>
  <style>
    .menu-data {
      color: rgb(255, 255, 255) !important;
      opacity: 1 !important;
      font-weight: 700 !important;
    }
  </style>
</head>

<body>
  <div class="menu-container"></div>
  <div class="content-container">
    <div class="content">
      <div class="content-table flex-column">
        <div class="flex-row">
          <div class="flex-item flex-column">
            <h2>Download Smell Report Data</h2>
            <hr>
            <p class="text-small-margin add-bottom-margin">
              We take every precaution to protect any personally identifiable data.
              All information shown on the public map visualization for Smell MyCity is anonymized and location data is skewed to protect your privacy.
              Personal contact information you enter in the settings tab is only made available to the relevant local regulatory agency.
              Our backend database only contains anonymous User ID's created by your app service (Apple or Google Play).
            </p>
            <span>Select a city or zipcode:</span>
            <div class="custom-dropdown large add-top-margin-small add-bottom-margin" id="region-dropdown">
              <a tabindex="0" href="javascript:void(0)"><span></span></a>
              <div></div>
            </div>
            <div id="zipcode-input-container">
              <span>Enter zipcodes, seperated by comma:</span>
              <div class="add-top-margin-small add-bottom-margin">
                <input id="zipcode-input" class="custom-textbox" type="text" value="15213,15217">
              </div>
            </div>
            <span>Select a timezone:</span>
            <div class="custom-dropdown large add-top-margin-small add-bottom-margin" id="timezone-dropdown">
              <a tabindex="0" href="javascript:void(0)"><span></span></a>
              <div></div>
            </div>
            <span>Select a time range:</span>
            <div class="add-top-margin-small add-bottom-margin">
              <input type="text" id="from-time-input" name="from" class="custom-textbox">
              <label for="to-time-input" id="to-time-txt">to</label>
              <input type="text" id="to-time-input" name="to" class="custom-textbox">
            </div>
            <div id="download-button-container">
              <span>Dowload data in csv format:</span>
              <div class="control-group">
                <a class="custom-button custom-button-primary" id="download-button">Download Smell Report</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

  ga('create', 'UA-10682694-20', 'auto');
  ga('send', 'pageview');

  // Timezone
  var timezone_offset_array_selected = [
    0, -5, -4, -6, -5, -7, -6, -8, -7
  ];
  var timezone_txt_array_selected = [
    "(GMT+00:00) UTC Time",
    "(GMT-05:00) Eastern Time",
    "(GMT-04:00) Eastern Daylight Time",
    "(GMT-06:00) Central Time",
    "(GMT-05:00) Central Daylight Time",
    "(GMT-07:00) Mountain Time",
    "(GMT-06:00) Mountain Daylight Time",
    "(GMT-08:00) Pacific Time",
    "(GMT-07:00) Pacific Daylight Time"
  ];

  function init() {
    var widgets = new edaplotjs.Widgets();
    var $zipcode_input_container = $("#zipcode-input-container");
    var $zipcode_input = $("#zipcode-input");
    var $download_button = $("#download-button");
    var cached_url_settings = {};

    var updateDownloadUrl = function () {
      $download_button.attr("href", getUrl(cached_url_settings));
    };

    $.getJSON("https://api.smellpittsburgh.org/api/v2/cities", function (data) {
      // Get city names and ids
      var city_names = [];
      var city_ids = [];
      for (var i = 0; i < data.length; i++) {
        var city = data[i];
        city_names.push(city["name"]);
        city_ids.push(city["id"]);
      }
      city_names.push("All Cities");
      city_names.push("Zipcode");
      city_ids.push(null);
      city_ids.push(-1);

      // Set region UI
      var init_city_index = 0;
      widgets.setCustomDropdown($("#region-dropdown"), {
        items: city_names,
        init_index: init_city_index,
        on_item_click_callback: function ($ui) {
          delete cached_url_settings["city_id"];
          delete cached_url_settings["zipcodes"];
          if ($ui.data("id") == -1) {
            $zipcode_input_container.show();
            cached_url_settings["zipcodes"] = $zipcode_input.val().replace(/\s/g, "");
          } else {
            $zipcode_input_container.hide();
            var cid = $ui.data("id");
            if (typeof cid !== "undefined" && cid !== null) {
              cached_url_settings["city_id"] = cid;
            }
          }
          updateDownloadUrl();
        },
        on_item_create_callback: function ($ui, i) {
          $ui.data("id", city_ids[i]);
        }
      });

      // Set zipcode UI
      $zipcode_input.on("change", function () {
        delete cached_url_settings["city_id"];
        cached_url_settings["zipcodes"] = $zipcode_input.val().replace(/\s/g, "");
        updateDownloadUrl();
      });

      // Set timezone UI
      var init_timezone_index = 0;
      widgets.setCustomDropdown($("#timezone-dropdown"), {
        items: timezone_txt_array_selected,
        init_index: init_timezone_index,
        on_item_click_callback: function ($ui) {
          cached_url_settings["timezone_offset"] = $ui.data("offset");
          updateDownloadUrl();
        },
        on_item_create_callback: function ($ui, i) {
          $ui.data("offset", timezone_offset_array_selected[i]);
        }
      });

      // Set datepicker UI
      var $from = $("#from-time-input").datepicker({}).on("change", function () {
        $to.datepicker("option", "minDate", getDate(this));
        cached_url_settings["start_time"] = $from.datepicker("getDate");
        updateDownloadUrl();
      });
      var $to = $("#to-time-input").datepicker({}).on("change", function () {
        $from.datepicker("option", "maxDate", getDate(this));
        cached_url_settings["end_time"] = $to.datepicker("getDate");
        updateDownloadUrl();
      });
      var from_date = new Date(new Date().setDate(new Date().getDate() - 30));
      var to_date = new Date();
      $from.datepicker("setDate", from_date);
      $to.datepicker("setDate", to_date);
      $to.datepicker("option", "minDate", $from.datepicker("getDate"));
      $from.datepicker("option", "maxDate", $to.datepicker("getDate"));

      // Initialize and show the download button
      cached_url_settings = {
        "city_id": city_ids[init_city_index],
        "timezone_offset": timezone_offset_array_selected[init_timezone_index],
        "start_time": from_date,
        "end_time": to_date
      };
      updateDownloadUrl();
      $("#download-button-container").show();
    });
  }

  function getDate(element) {
    var dateFormat = "mm/dd/yy";
    var date;
    try {
      date = $.datepicker.parseDate(dateFormat, element.value);
    } catch (error) {
      date = null;
    }
    return date;
  }

  function safeGet(v, default_val) {
    if (typeof default_val === "undefined") default_val = "";
    return (typeof v === "undefined") ? default_val : v;
  }

  function getUrl(settings) {
    var root_url = "http://api.smellpittsburgh.org/";
    var api_url = "api/v2/smell_reports?format=csv";
    var url = root_url + api_url;
    settings = safeGet(settings, {});
    var city_id = settings["city_id"];
    var timezone_offset = settings["timezone_offset"];
    var zipcodes = settings["zipcodes"];
    var start_time = settings["start_time"];
    var end_time = settings["end_time"];
    var timezone_offset_diff = new Date().getTimezoneOffset() / 60 + timezone_offset;
    if (typeof city_id !== "undefined" && city_id !== "") {
      url += "&city_ids=" + city_id;
    }
    if (typeof timezone_offset !== "undefined" && timezone_offset !== "") {
      url += "&timezone_offset=" + (-parseInt(timezone_offset) * 60);
    }
    if (typeof zipcodes !== "undefined" && zipcodes !== "") {
      url += "&zipcodes=" + zipcodes;
    }
    if (typeof start_time !== "undefined" && start_time !== "") {
      start_time.setHours(0 - timezone_offset_diff, 0, 0, 0);
      url += "&start_time=" + parseInt(start_time.getTime() / 1000);
    }
    if (typeof end_time !== "undefined" && end_time !== "") {
      end_time.setHours(23 - timezone_offset_diff, 59, 59, 999);
      url += "&end_time=" + parseInt(end_time.getTime() / 1000);
    }
    return url;
  }

  $(init)
</script>

</html>